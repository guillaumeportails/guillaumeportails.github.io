(function(b,a){typeof define=='function'&&define.amd&&a.toGeoJSON?define(['leaflet'],function(c){b(c,a.toGeoJSON)}):typeof module=='object'&&module.exports?module.exports=function(e,c,d){return c===void 0&&(typeof a!='undefined'?c=require('leaflet'):c=require('leaflet')(e)),d===void 0&&(typeof a!='undefined'?d=require('togeojson'):d=require('togeojson')(e)),b(c,d),c}:typeof a!='undefined'&&a.L&&a.toGeoJSON&&b(a.L,a.toGeoJSON)})(function(a,b){var c=a.Class.extend({includes:a.Mixin.Events,options:{layer:a.geoJson,layerOptions:{},fileSizeLimit:1024},initialize:function(b,c){this._map=b,a.Util.setOptions(this,c),this._parsers={geojson:this._loadGeoJSON,json:this._loadGeoJSON,gpx:this._convertToGeoJSON,kml:this._convertToGeoJSON}},load:function(b){var e=(b.size/1024).toFixed(4),c,f,d;if(e>this.options.fileSizeLimit){this.fire('data:error',{error:new Error('File size exceeds limit ('+e+' > '+this.options.fileSizeLimit+'kb)')});return}if(c=b.name.split('.').pop(),f=this._parsers[c],!f){this.fire('data:error',{error:new Error('Unsupported file type '+b.type+'('+c+')')});return}return d=new FileReader,d.onload=a.Util.bind(function(a){try{this.fire('data:loading',{filename:b.name,format:c});var d=f.call(this,a.target.result,c);this.fire('data:loaded',{layer:d,filename:b.name,format:c})}catch(a){this.fire('data:error',{error:a})}},this),d.readAsText(b),d},_loadGeoJSON:function(a){typeof a=='string'&&(a=JSON.parse(a));var b=this.options.layer(a,this.options.layerOptions);if(b.getLayers().length===0)throw new Error('GeoJSON has no valid layers.');return this.options.addToMap&&b.addTo(this._map),b},_convertToGeoJSON:function(a,c){typeof a=='string'&&(a=(new window.DOMParser).parseFromString(a,'text/xml'));var d=b[c](a);return this._loadGeoJSON(d)}}),d=a.Control.extend({statics:{TITLE:'Load local file (GPX, KML, GeoJSON)',LABEL:'&#8965;'},options:{position:'topleft',fitBounds:!0,layerOptions:{},addToMap:!0,fileSizeLimit:1024},initialize:function(b){a.Util.setOptions(this,b),this.loader=null},onAdd:function(b){return this.loader=a.Util.fileLoader(b,this.options),this.loader.on('data:loaded',function(a){this.options.fitBounds&&window.setTimeout(function(){b.fitBounds(a.layer.getBounds())},500)},this),this._initDragAndDrop(b),this._initContainer()},_initDragAndDrop:function(a){var d=this,e=a._container,b={dragenter:function(){a.scrollWheelZoom.disable()},dragleave:function(){a.scrollWheelZoom.enable()},dragover:function(a){a.stopPropagation(),a.preventDefault()},drop:function(b){b.stopPropagation(),b.preventDefault(),d._loadFiles(b.dataTransfer.files),a.scrollWheelZoom.enable()}},c;for(c in b)e.addEventListener(c,b[c],!1)},_initContainer:function(){var h=this,e='leaflet-control-filelayer leaflet-control-zoom',f='leaflet-bar',g=f+'-part',d=a.DomUtil.create('div',e+' '+f),c=a.DomUtil.create('a',e+'-in '+g,d),b;return c.innerHTML=a.Control.FileLayerLoad.LABEL,c.href='#',c.title=a.Control.FileLayerLoad.TITLE,b=a.DomUtil.create('input','hidden',d),b.type='file',b.multiple='multiple',this.options.formats?b.accept=this.options.formats.join(','):b.accept='.gpx,.kml,.geojson',b.style.display='none',b.addEventListener('change',function(){h._loadFiles(this.files),this.value=''},!1),a.DomEvent.disableClickPropagation(c),a.DomEvent.on(c,'click',function(a){b.click(),a.preventDefault()}),d},_loadFiles:function(a){var b,c;a=Array.prototype.slice.apply(a),b=this.loader,c=a.length,setTimeout(function(){b.load(a.shift()),a.length>0&&setTimeout(arguments.callee,25)},25)}});a.Util.FileLoader=c,a.Util.fileLoader=function(b,c){return new a.Util.FileLoader(b,c)},a.Control.FileLayerLoad=d,a.Control.fileLayerLoad=function(b){return new a.Control.FileLayerLoad(b)}},window)